#-----------------------------------------------------
# PIPELINE STAGES
#-----------------------------------------------------

stages:
  - test
  - notify


#-----------------------------------------------------
# TEST: QA TEST
#-----------------------------------------------------


qa_test:
  stage: test
  only:
    - main
  variables:
    QA_ENVIRONMENT: "recette"
    WEB_DRIVER: "chrome"
  allow_failure: true
  before_script:
    - google-chrome-stable --headless --disable-gpu --print-to-pdf https://www.chromestatus.com/ --no-sandbox
  script:
    - mvn clean -Denvironment=$QA_ENVIRONMENT -DwebDriver=$WEB_DRIVER test
  after_script:
    - ps aux | grep chrome | awk ' { print $2 } ' | xargs kill -9 || true
  artifacts:
    when: always
    name: "qa_report"
    paths:
      - target/reports/report.html
    expire_in: 1 h
  tags:
    - gitlab-runner


#-----------------------------------------------------
# TEST: QA NOTIFY
#-----------------------------------------------------

qa_notify:
  stage: notify
  only:
    - main
  script:
    - ls target/reports
    - curl -s --user "api:$MAILGUN_API_KEY" "https://api.mailgun.net/v3/$MAILGUN_DOMAIN/messages" -F from='admin.gitlab@coral-io.com' -F to='a.aouadi@coral-io.fr' -F subject='Uwas Api pipeline results' -F template='uwas-qa' -F attachment='@report.html'
  tags:
    - gitlab-runner
